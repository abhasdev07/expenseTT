"""Authentication routes."""

from flask import jsonify, request
from flask_jwt_extended import (
    create_access_token,
    create_refresh_token,
    get_jwt_identity,
    jwt_required,
)
from marshmallow import ValidationError

from app import db
from app.auth import auth_bp
from app.models import Category, User
from app.schemas import LoginSchema, UserSchema

user_schema = UserSchema()
login_schema = LoginSchema()


@auth_bp.route("/register", methods=["POST"])
def register():
    """Register a new user."""
    try:
        # Validate input
        data = login_schema.load(request.json)

        # Check if user already exists
        if User.query.filter_by(email=data["email"]).first():
            return jsonify({"error": "Email already registered"}), 400

        # Create new user
        user = User(
            username=data["email"].split("@")[0],  # Generate username from email
            email=data["email"],
        )
        user.set_password(data["password"])

        db.session.add(user)
        db.session.flush()  # Get user.id before commit

        # Create default categories for new user
        default_categories = [
            # Income Categories
            {
                "name": "Salary",
                "type": "income",
                "icon": "briefcase",
                "color": "#10b981",
            },
            {
                "name": "Freelance",
                "type": "income",
                "icon": "laptop",
                "color": "#059669",
            },
            {
                "name": "Investments",
                "type": "income",
                "icon": "trending-up",
                "color": "#34d399",
            },
            {
                "name": "Business",
                "type": "income",
                "icon": "building",
                "color": "#6ee7b7",
            },
            {
                "name": "Other Income",
                "type": "income",
                "icon": "plus-circle",
                "color": "#a7f3d0",
            },
            # Expense Categories
            {
                "name": "Food & Dining",
                "type": "expense",
                "icon": "utensils",
                "color": "#ef4444",
            },
            {
                "name": "Transportation",
                "type": "expense",
                "icon": "car",
                "color": "#f97316",
            },
            {
                "name": "Shopping",
                "type": "expense",
                "icon": "shopping-bag",
                "color": "#f59e0b",
            },
            {
                "name": "Entertainment",
                "type": "expense",
                "icon": "film",
                "color": "#eab308",
            },
            {
                "name": "Bills & Utilities",
                "type": "expense",
                "icon": "file-text",
                "color": "#84cc16",
            },
            {
                "name": "Healthcare",
                "type": "expense",
                "icon": "heart",
                "color": "#22c55e",
            },
            {
                "name": "Education",
                "type": "expense",
                "icon": "book",
                "color": "#06b6d4",
            },
            {"name": "Travel", "type": "expense", "icon": "plane", "color": "#0ea5e9"},
            {"name": "Housing", "type": "expense", "icon": "home", "color": "#3b82f6"},
            {
                "name": "Personal Care",
                "type": "expense",
                "icon": "user",
                "color": "#6366f1",
            },
            {
                "name": "Gifts & Donations",
                "type": "expense",
                "icon": "gift",
                "color": "#8b5cf6",
            },
            {
                "name": "Insurance",
                "type": "expense",
                "icon": "shield",
                "color": "#a855f7",
            },
            {
                "name": "Other Expenses",
                "type": "expense",
                "icon": "more-horizontal",
                "color": "#d946ef",
            },
        ]

        for cat_data in default_categories:
            category = Category(
                user_id=user.id,
                name=cat_data["name"],
                type=cat_data["type"],
                icon=cat_data["icon"],
                color=cat_data["color"],
            )
            db.session.add(category)

        db.session.commit()

        # Create tokens - convert user.id to string for JWT
        access_token = create_access_token(identity=str(user.id))
        refresh_token = create_refresh_token(identity=str(user.id))

        return jsonify(
            {
                "message": "User registered successfully",
                "user": user_schema.dump(user),
                "access_token": access_token,
                "refresh_token": refresh_token,
            }
        ), 201

    except ValidationError as err:
        return jsonify({"error": "Validation error", "messages": err.messages}), 400
    except Exception as e:
        db.session.rollback()
        return jsonify({"error": "Registration failed", "message": str(e)}), 500


@auth_bp.route("/login", methods=["POST"])
def login():
    """Login user."""
    try:
        # Validate input
        data = login_schema.load(request.json)

        # Find user
        user = User.query.filter_by(email=data["email"]).first()

        if not user or not user.check_password(data["password"]):
            return jsonify({"error": "Invalid email or password"}), 401

        # Create tokens - convert user.id to string for JWT
        access_token = create_access_token(identity=str(user.id))
        refresh_token = create_refresh_token(identity=str(user.id))

        return jsonify(
            {
                "message": "Login successful",
                "user": user_schema.dump(user),
                "access_token": access_token,
                "refresh_token": refresh_token,
            }
        ), 200

    except ValidationError as err:
        return jsonify({"error": "Validation error", "messages": err.messages}), 400
    except Exception as e:
        return jsonify({"error": "Login failed", "message": str(e)}), 500


@auth_bp.route("/refresh", methods=["POST"])
@jwt_required(refresh=True)
def refresh():
    """Refresh access token."""
    try:
        current_user_id = get_jwt_identity()
        access_token = create_access_token(identity=current_user_id)

        return jsonify({"access_token": access_token}), 200

    except Exception as e:
        return jsonify({"error": "Token refresh failed", "message": str(e)}), 500


@auth_bp.route("/profile", methods=["GET"])
@jwt_required()
def get_profile():
    """Get user profile."""
    try:
        current_user_id = get_jwt_identity()
        # Convert back to int for database query
        user = User.query.get_or_404(int(current_user_id))

        return jsonify({"user": user_schema.dump(user)}), 200

    except Exception as e:
        return jsonify({"error": "Failed to fetch profile", "message": str(e)}), 500


@auth_bp.route("/profile", methods=["PUT"])
@jwt_required()
def update_profile():
    """Update user profile."""
    try:
        current_user_id = get_jwt_identity()
        # Convert back to int for database query
        user = User.query.get_or_404(int(current_user_id))

        data = request.json

        # Update allowed fields
        if "username" in data:
            # Check if username is taken
            existing = User.query.filter_by(username=data["username"]).first()
            if existing and existing.id != user.id:
                return jsonify({"error": "Username already taken"}), 400
            user.username = data["username"]

        if "theme_preference" in data:
            if data["theme_preference"] in ["light", "dark"]:
                user.theme_preference = data["theme_preference"]

        db.session.commit()

        return jsonify(
            {"message": "Profile updated successfully", "user": user_schema.dump(user)}
        ), 200

    except Exception as e:
        db.session.rollback()
        return jsonify({"error": "Failed to update profile", "message": str(e)}), 500


@auth_bp.route("/profile/theme", methods=["PUT"])
@jwt_required()
def update_theme():
    """Update user theme preference."""
    try:
        current_user_id = get_jwt_identity()
        # Convert back to int for database query
        user = User.query.get_or_404(int(current_user_id))

        data = request.json
        theme = data.get("theme")

        if theme not in ["light", "dark"]:
            return jsonify({"error": 'Invalid theme. Must be "light" or "dark"'}), 400

        user.theme_preference = theme
        db.session.commit()

        return jsonify({"message": "Theme updated successfully", "theme": theme}), 200

    except Exception as e:
        db.session.rollback()
        return jsonify({"error": "Failed to update theme", "message": str(e)}), 500
